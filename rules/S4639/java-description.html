<p>Libraries used to unarchive a file (zip, bzip2, tar, …​) do what they were made for: they extract the content of the archive blindly, creating on the filesystem directories and files corresponding exactly to the content of the archive. Using a specially crafted archive containing some path traversal filenames, it is possible to create directories/files outside of the dir where the archive is extracted. This can lead to overwriting an executable or a configuration file with a file containing malicious code and transform a simple archive into a way to execute arbitrary code.</p>
<h2>Noncompliant Code Example</h2>
<pre>
Enumeration&lt;? extends ZipEntry&gt; entries = zipFile.entries();
while (entries.hasMoreElements()) {
  ZipEntry entry = entries.nextElement();
  File extractedFile = new File(toDir, entry.getName());

  FileOutputStream fos = new FileOutputStream(extractedFile); // Noncompliant; entry.getName() that was used to created "extractedFile" may be tainted with "../../../../../../../../tmp/evil.sh"
  InputStream input = zipFile.getInputStream(entry);
  IOUtils.copy(input, fos);
}
</pre>
<h2>Compliant Solution</h2>
<pre>
Enumeration&lt;? extends ZipEntry&gt; entries = zipFile.entries();
while (entries.hasMoreElements()) {
  ZipEntry zipEntry = entries.nextElement();
  String fileName = zipEntry.getName();
  File extractedFile = new File(toDir, fileName);

  String canonicalDirPath = toDir.getCanonicalPath();
  String canonicalDestPath = extractedFile.getCanonicalPath();

  sanitizeAgainstZipFlipVulnerability(fileName, canonicalDestPath, canonicalDirPath); // Compliant

  FileOutputStream fos = new FileOutputStream(extractedFile);
  InputStream input = zipFile.getInputStream(entry);
  IOUtils.copy(input, fos);
}

public static void sanitizeAgainstZipFlipVulnerability(String fileName, String canonicalDestPath, String canonicalDirPath) throws ArchiverException {
    if (fileName.indexOf("..") != -1 &amp;&amp; !canonicalDestPath.startsWith(canonicalDirPath + File.separator)) { // Sanitizer
      throw new ArchiverException("The file " + fileName + " is trying to leave the target output directory.");
    }
  }
</pre>
<h2>See</h2>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</li>
<li><a href="http://cwe.mitre.org/data/definitions/409.html">MITRE, CWE-409</a> - Improper Handling of Highly Compressed Data (Data Amplification)</li>
<li><a href="https://wiki.sei.cmu.edu/confluence/display/java/IDS04-J.+Safely+extract+files+from+ZipInputStream">CERT, IDS04-J.</a> - Safely extract files from ZipInputStream</li>
<li>Snyk Research Team: <a href="https://snyk.io/research/zip-slip-vulnerability">Zip Slip Vulnerability</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2016-0709">https://nvd.nist.gov/vuln/detail/CVE-2016-0709</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2017-5946">https://nvd.nist.gov/vuln/detail/CVE-2017-5946</a></li>
</ul>
