<p>Executing XPATH expressions is security-sensitive. It has led in the past to the following vulnerabilities:</p>
<ul>
<li><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-6272">CVE-2016-6272</a></li>
<li><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-9149">CVE-2016-9149</a></li>
<li><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-4837">CVE-2012-4837</a></li>
</ul>
<p>User provided data such as URL parameters should always be considered as untrusted and tainted. Constructing XPath expressions directly from tainted data enables attackers to inject specially crafted values that changes the initial meaning of the expression itself. Successful XPath injections attacks can read sensitive information from the XML document.</p>
<h2>Ask Yourself Whether</h2>
<ul>
<li>the XPATH expression might contain some unsafe input coming from a user.</li>
</ul>
<p>You are at risk if you answered yes to this question.</p>
<h2>Recommended Secure Coding Practices</h2>
<p>Sanitize any user input before using it in an XPATH expression.</p>
<h2>Sensitive Code Example</h2>
<pre>
// === javax.xml.xpath.XPath ===
import javax.xml.namespace.QName;
import javax.xml.xpath.XPath;

import org.xml.sax.InputSource;

class M {
    void foo(XPath xpath, String expression, InputSource source, QName returnType, Object item) throws Exception {
        xpath.compile(expression); // Sensitive
        xpath.evaluate(expression, source); // Sensitive
        xpath.evaluate(expression, source, returnType); // Sensitive
        xpath.evaluate(expression, item); // Sensitive
        xpath.evaluate(expression, item, returnType); // Sensitive
    }
}
</pre>
<pre>
// === Apache XML Security ===
import org.apache.xml.utils.PrefixResolver;
import org.apache.xml.security.utils.XPathAPI;
import org.w3c.dom.Node;

class M {
    void foo(XPathAPI api, Node contextNode, String str, Node namespaceNode, PrefixResolver prefixResolver,
            Node xpathnode) throws Exception {
        api.evaluate(contextNode, xpathnode, str, namespaceNode); // Sensitive
        api.selectNodeList(contextNode, xpathnode, str, namespaceNode); // Sensitive
    }
}
</pre>
<pre>
// === Apache Xalan ===
import org.apache.xml.utils.PrefixResolver;
import org.apache.xpath.XPathAPI;
import org.w3c.dom.Node;

class M {
    void foo(XPathAPI api, Node contextNode, String str, Node namespaceNode, PrefixResolver prefixResolver)
            throws Exception {
        XPathAPI.eval(contextNode, str); // Sensitive
        XPathAPI.eval(contextNode, str, namespaceNode); // Sensitive
        XPathAPI.eval(contextNode, str, prefixResolver); // Sensitive
        XPathAPI.selectNodeIterator(contextNode, str); // Sensitive
        XPathAPI.selectNodeIterator(contextNode, str, namespaceNode); // Sensitive
        XPathAPI.selectNodeList(contextNode, str); // Sensitive
        XPathAPI.selectNodeList(contextNode, str, namespaceNode); // Sensitive
        XPathAPI.selectSingleNode(contextNode, str); // Sensitive
        XPathAPI.selectSingleNode(contextNode, str, namespaceNode); // Sensitive
    }
}
</pre>
<pre>
// === org.apache.commons.jxpath ===
import org.apache.commons.jxpath.JXPathContext;

abstract class A extends JXPathContext{
    A(JXPathContext compilationContext, Object contextBean) {
        super(compilationContext, contextBean);
    }


    void foo(JXPathContext context, String str, Object obj, Class&lt;?&gt; requiredType) {
        JXPathContext.compile(str); // Sensitive
        this.compilePath(str); // Sensitive
        context.createPath(str); // Sensitive
        context.createPathAndSetValue(str, obj); // Sensitive
        context.getPointer(str); // Sensitive
        context.getValue(str); // Sensitive
        context.getValue(str, requiredType); // Sensitive
        context.iterate(str); // Sensitive
        context.iteratePointers(str); // Sensitive
        context.removeAll(str); // Sensitive
        context.removePath(str); // Sensitive
        context.selectNodes(str); // Sensitive
        context.selectSingleNode(str); // Sensitive
        context.setValue(str, obj); // Sensitive
    }
}
</pre>
<h2>See</h2>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</li>
<li><a href="http://cwe.mitre.org/data/definitions/643">MITRE, CWE-643</a> - Improper Neutralization of Data within XPath Expressions</li>
<li><a href="https://www.securecoding.cert.org/confluence/x/BwLEAw">CERT, IDS53-J.</a> - Prevent XPath Injection</li>
</ul>
