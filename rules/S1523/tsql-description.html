<p>Executing code dynamically is security sensitive. It has led in the past to the following vulnerabilities:</p>
<ul>
<li><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-9807">CVE-2017-9807</a></li>
<li><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-9802">CVE-2017-9802</a></li>
</ul>
<p>Some APIs enable the execution of dynamic code by providing it as strings at runtime. These APIs might be useful in some very specific meta-programming use-cases. However most of the time their use is frowned upon as they also increase the risk of <a href="https://www.owasp.org/index.php/Code_Injection">Injected Code</a>. Such attacks can either run on the server or in the client (exemple: XSS attack) and have a huge impact on an application’s security.</p>
<p>Both &lt;code&gt;EXECUTE( …​ )&lt;/code&gt; and &lt;code&gt;EXEC( …​ )&lt;/code&gt; execute as a command the string passed as an argument. They are safe only if the argument is composed of constant character string expressions. But if the command string is dynamically built using external parameters, then it is considered very dangerous because executing a random string allows the execution of arbitrary code.</p>
<p>This rule marks for review each occurrence of &lt;code&gt;EXEC&lt;/code&gt; and &lt;code&gt;EXECUTE&lt;/code&gt;. This rule does not detect code injections. It only highlights the use of APIs which should be used sparingly and very carefully. The goal is to guide security code reviews.</p>
<h2>Ask Yourself Whether</h2>
<ul>
<li>the executed code may come from an untrusted source and hasn’t been sanitized.</li>
<li>you really need to run code dynamically.</li>
</ul>
<p>There is a risk if you answered yes to any of those questions.</p>
<h2>Recommended Secure Coding Practices</h2>
<p>The best solution is to not run code provided by an untrusted source. If you really need to build a command string using external parameters, you should use &lt;code&gt;EXEC sp_executesql&lt;/code&gt; instead.</p>
<p>Do not try to create a blacklist of dangerous code. It is impossible to cover all attacks that way.</p>
<h2>Noncompliant Code Example</h2>
<pre>
CREATE PROCEDURE USER_BY_EMAIL(@email VARCHAR(255)) AS
BEGIN
  EXEC('USE AuthDB; SELECT id FROM user WHERE email = ''' + @email + ''' ;'); -- Noncompliant could inject code using @email
END
</pre>
<h2>Compliant Solution</h2>
<pre>
CREATE PROCEDURE USER_BY_EMAIL(@email VARCHAR(255)) AS
BEGIN
  EXEC sp_executesql 'USE AuthDB; SELECT id FROM user WHERE email = @user_email;',
                     '@user_email VARCHAR(255)',
                      @user_email = @email;
END
</pre>
<h2>See</h2>
<ul>
<li><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</li>
<li><a href="http://cwe.mitre.org/data/definitions/95.html">MITRE CWE-95</a> - Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')</li>
</ul>
