<p>Pluggable authentication module (PAM) is a mechanism used on many unix variants to provide a unified way to authenticate users, independently of the underlying authentication scheme.</p>
<p>When authenticating users, it is strongly recommended to check the validity of the account (not locked, not expired …​), otherwise it leads to unauthorized access to resources.</p>
<h2>Noncompliant Code Examples</h2>
<p>The account validity is not checked with &lt;code&gt;pam_acct_mgmt&lt;/code&gt; when authenticating a user with &lt;code&gt;pam_authenticate&lt;/code&gt;:</p>
<pre>
int valid(pam_handle_t *pamh) {
    if (pam_authenticate(pamh, PAM_DISALLOW_NULL_AUTHTOK) != PAM_SUCCESS) { // Noncompliant - missing pam_acct_mgmt
        return -1;
    }

    return 0;
}
</pre>
<p>The return value of &lt;code&gt;pam_acct_mgmt&lt;/code&gt; is not checked:</p>
<pre>
int valid(pam_handle_t *pamh) {
    if (pam_authenticate(pamh, PAM_DISALLOW_NULL_AUTHTOK) != PAM_SUCCESS) {
        return -1;
    }
    pam_acct_mgmt(pamh, 0); // Noncompliant
    return 0;
}
</pre>
<h2>Compliant Solution</h2>
<p>When authenticating a user with &lt;code&gt;pam_authenticate&lt;/code&gt;, check the account validity with &lt;code&gt;pam_acct_mgmt&lt;/code&gt;:</p>
<pre>
int valid(pam_handle_t *pamh) {
    if (pam_authenticate(pamh, PAM_DISALLOW_NULL_AUTHTOK) != PAM_SUCCESS) {
        return -1;
    }
    if (pam_acct_mgmt(pamh, 0) != PAM_SUCCESS) { // Compliant
        return -1;
    }
    return 0;
}
</pre>
<h2>See</h2>
<ul>
<li><a href="https://cwe.mitre.org/data/definitions/304.html">MITRE, CWE-304</a> - Missing Critical Step in Authentication</li>
</ul>
